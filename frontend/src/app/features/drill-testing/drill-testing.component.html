<div class="test-management-container">
  <div class="header-section">
    <div class="title-section">
      <h1 class="page-title">Drill Test</h1>
      <p class="page-subtitle">Plan, execute, and track drill tests and issues</p>
    </div>
    <div class="header-actions">
      <button class="btn-primary" (click)="openTestCaseModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        New Test Case
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <button 
      class="tab" 
      [class.active]="activeTab === 'modules'"
      (click)="activeTab = 'modules'; onTabChange()">
      Modules
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'test-cases'"
      (click)="activeTab = 'test-cases'; onTabChange()">
      Test Cases
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'executions'"
      (click)="activeTab = 'executions'; onTabChange()">
      Executions
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'defects'"
      (click)="activeTab = 'defects'; onTabChange()">
      Defects
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'reports'"
      (click)="activeTab = 'reports'; onTabChange()">
      Reports
    </button>
  </div>

  <!-- Modules Tab -->
  <div class="tab-content" *ngIf="activeTab === 'modules'">
    <div class="section-header">
      <h2>Test Modules</h2>
      <button class="btn-secondary" (click)="openModuleModal()">+ New Module</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="card" *ngFor="let module of modules">
        <h3 class="card-title">{{ module.name }}</h3>
        <p class="card-description">{{ module.description || 'No description' }}</p>
        <div class="card-footer">
          <span class="text-sm text-gray-500">Created by {{ module.createdByUsername }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Cases Tab -->
  <div class="tab-content" *ngIf="activeTab === 'test-cases'">
    <div class="section-header">
      <div class="search-box">
        <input 
          type="text" 
          placeholder="Search test cases..." 
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
          class="search-input">
        <button class="btn-filter" (click)="showFilters = !showFilters" [class.active]="showFilters">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1rem; height: 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
          </svg>
          Filters
        </button>
      </div>
      <button class="btn-secondary" (click)="openTestCaseModal()">+ New Test Case</button>
    </div>
    
    <!-- Advanced Filters -->
    <div class="filters-panel" *ngIf="showFilters" [formGroup]="filterForm">
      <div class="filters-grid">
        <div class="form-group">
          <label>Status</label>
          <select formControlName="status" (change)="applyFilters()" class="form-input">
            <option [value]="null">All Statuses</option>
            <option [value]="TestCaseStatus.DRAFT">Draft</option>
            <option [value]="TestCaseStatus.APPROVED">Approved</option>
            <option [value]="TestCaseStatus.ARCHIVED">Archived</option>
          </select>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select formControlName="priority" (change)="applyFilters()" class="form-input">
            <option [value]="null">All Priorities</option>
            <option [value]="Priority.LOW">Low</option>
            <option [value]="Priority.MEDIUM">Medium</option>
            <option [value]="Priority.HIGH">High</option>
            <option [value]="Priority.CRITICAL">Critical</option>
          </select>
        </div>
        <div class="form-group">
          <label>Module</label>
          <select formControlName="moduleId" (change)="applyFilters()" class="form-input">
            <option [value]="null">All Modules</option>
            <option *ngFor="let module of modules" [value]="module.id">{{ module.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Assigned To</label>
          <select formControlName="assignedToId" (change)="applyFilters()" class="form-input">
            <option [value]="null">All Users</option>
            <option *ngFor="let user of users" [value]="user.id">{{ user.username }}</option>
          </select>
        </div>
      </div>
      <div class="filters-actions">
        <button class="btn-secondary" (click)="clearFilters()">Clear All</button>
      </div>
    </div>
    
    <div class="table-container">
      <div class="table-header-info">
        <span>Showing {{ getPaginatedItems(filteredTestCases, 'testCases').length }} of {{ filteredTestCases.length }} test cases</span>
        <select (change)="changePageSize(+$any($event.target).value)" class="page-size-select">
          <option [value]="10">10 per page</option>
          <option [value]="25">25 per page</option>
          <option [value]="50">50 per page</option>
          <option [value]="100">100 per page</option>
        </select>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Module</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let testCase of getPaginatedItems(filteredTestCases, 'testCases')">
            <td>{{ testCase.id }}</td>
            <td>
              <a (click)="openTestCaseModal(testCase)" class="link">{{ testCase.title }}</a>
            </td>
            <td>{{ testCase.moduleName || 'N/A' }}</td>
            <td>
              <span [class]="'badge ' + getPriorityColor(testCase.priority)">
                {{ testCase.priority }}
              </span>
            </td>
            <td>
              <span [class]="'badge ' + getStatusColor(testCase.status)">
                {{ testCase.status }}
              </span>
            </td>
            <td>{{ testCase.assignedToUsername || 'Unassigned' }}</td>
            <td>
              <button class="btn-icon" (click)="openExecutionModal(testCase.id)" title="Execute">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.986V5.653z" />
                </svg>
              </button>
              <button class="btn-icon" (click)="openCommentModal('test-case', testCase.id)" title="Comments">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                </svg>
              </button>
            </td>
          </tr>
          <tr *ngIf="getPaginatedItems(filteredTestCases, 'testCases').length === 0">
            <td colspan="7" class="text-center">No test cases found</td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination -->
      <div class="pagination" *ngIf="totalPages.testCases > 1">
        <button class="pagination-btn" (click)="goToPage(currentPage.testCases - 1, 'testCases')" [disabled]="currentPage.testCases === 1">
          Previous
        </button>
        <span class="pagination-info">Page {{ currentPage.testCases }} of {{ totalPages.testCases }}</span>
        <button class="pagination-btn" (click)="goToPage(currentPage.testCases + 1, 'testCases')" [disabled]="currentPage.testCases === totalPages.testCases">
          Next
        </button>
      </div>
    </div>
  </div>

  <!-- Executions Tab -->
  <div class="tab-content" *ngIf="activeTab === 'executions'">
    <div class="section-header">
      <div class="search-box">
        <input 
          type="text" 
          placeholder="Search executions..." 
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
          class="search-input">
        <button class="btn-filter" (click)="showFilters = !showFilters" [class.active]="showFilters">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1rem; height: 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
          </svg>
          Filters
        </button>
      </div>
      <button class="btn-secondary" (click)="openExecutionModal()">+ New Execution</button>
    </div>
    
    <!-- Advanced Filters for Executions -->
    <div class="filters-panel" *ngIf="showFilters && activeTab === 'executions'" [formGroup]="filterForm">
      <div class="filters-grid">
        <div class="form-group">
          <label>Status</label>
          <select formControlName="status" (change)="applyFilters()" class="form-input">
            <option [value]="null">All Statuses</option>
            <option [value]="ExecutionStatus.PASSED">Passed</option>
            <option [value]="ExecutionStatus.FAILED">Failed</option>
            <option [value]="ExecutionStatus.BLOCKED">Blocked</option>
            <option [value]="ExecutionStatus.RETEST">Retest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date From</label>
          <input type="date" formControlName="dateFrom" (change)="applyFilters()" class="form-input">
        </div>
        <div class="form-group">
          <label>Date To</label>
          <input type="date" formControlName="dateTo" (change)="applyFilters()" class="form-input">
        </div>
      </div>
      <div class="filters-actions">
        <button class="btn-secondary" (click)="clearFilters()">Clear All</button>
      </div>
    </div>
    
    <div class="table-container">
      <div class="table-header-info">
        <span>Showing {{ getPaginatedItems(filteredExecutions, 'executions').length }} of {{ filteredExecutions.length }} executions</span>
        <select (change)="changePageSize(+$any($event.target).value)" class="page-size-select">
          <option [value]="10">10 per page</option>
          <option [value]="25">25 per page</option>
          <option [value]="50">50 per page</option>
          <option [value]="100">100 per page</option>
        </select>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Test Case</th>
            <th>Status</th>
            <th>Executed By</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let execution of getPaginatedItems(filteredExecutions, 'executions')">
            <td>{{ execution.id }}</td>
            <td>{{ execution.testCaseTitle }}</td>
            <td>
              <span [class]="'badge ' + getStatusColor(execution.status)">
                {{ execution.status }}
              </span>
            </td>
            <td>{{ execution.executedByUsername }}</td>
            <td>{{ execution.executedAt | date:'short' }}</td>
            <td>
              <button 
                *ngIf="execution.status === ExecutionStatus.FAILED"
                class="btn-sm btn-danger" 
                (click)="openDefectModal(execution.testCaseId, execution.id)">
                Log Defect
              </button>
            </td>
          </tr>
          <tr *ngIf="getPaginatedItems(filteredExecutions, 'executions').length === 0">
            <td colspan="6" class="text-center">No executions found</td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination -->
      <div class="pagination" *ngIf="totalPages.executions > 1">
        <button class="pagination-btn" (click)="goToPage(currentPage.executions - 1, 'executions')" [disabled]="currentPage.executions === 1">
          Previous
        </button>
        <span class="pagination-info">Page {{ currentPage.executions }} of {{ totalPages.executions }}</span>
        <button class="pagination-btn" (click)="goToPage(currentPage.executions + 1, 'executions')" [disabled]="currentPage.executions === totalPages.executions">
          Next
        </button>
      </div>
    </div>
  </div>

  <!-- Defects Tab -->
  <div class="tab-content" *ngIf="activeTab === 'defects'">
    <div class="section-header">
      <div class="search-box">
        <input 
          type="text" 
          placeholder="Search defects..." 
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
          class="search-input">
        <button class="btn-filter" (click)="showFilters = !showFilters" [class.active]="showFilters">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1rem; height: 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
          </svg>
          Filters
        </button>
      </div>
      <button class="btn-secondary" (click)="openDefectModal()">+ New Defect</button>
    </div>
    
    <!-- Advanced Filters for Defects -->
    <div class="filters-panel" *ngIf="showFilters && activeTab === 'defects'" [formGroup]="filterForm">
      <div class="filters-grid">
        <div class="form-group">
          <label>Severity</label>
          <select formControlName="severity" (change)="applyFilters()" class="form-input">
            <option [value]="null">All Severities</option>
            <option [value]="DefectSeverity.LOW">Low</option>
            <option [value]="DefectSeverity.MEDIUM">Medium</option>
            <option [value]="DefectSeverity.HIGH">High</option>
            <option [value]="DefectSeverity.CRITICAL">Critical</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select formControlName="defectStatus" (change)="applyFilters()" class="form-input">
            <option [value]="null">All Statuses</option>
            <option [value]="DefectStatus.NEW">New</option>
            <option [value]="DefectStatus.IN_PROGRESS">In Progress</option>
            <option [value]="DefectStatus.RESOLVED">Resolved</option>
            <option [value]="DefectStatus.CLOSED">Closed</option>
          </select>
        </div>
        <div class="form-group">
          <label>Assigned To</label>
          <select formControlName="assignedToId" (change)="applyFilters()" class="form-input">
            <option [value]="null">All Users</option>
            <option *ngFor="let user of users" [value]="user.id">{{ user.username }}</option>
          </select>
        </div>
      </div>
      <div class="filters-actions">
        <button class="btn-secondary" (click)="clearFilters()">Clear All</button>
      </div>
    </div>
    
    <div class="table-container">
      <div class="table-header-info">
        <span>Showing {{ getPaginatedItems(filteredDefects, 'defects').length }} of {{ filteredDefects.length }} defects</span>
        <select (change)="changePageSize(+$any($event.target).value)" class="page-size-select">
          <option [value]="10">10 per page</option>
          <option [value]="25">25 per page</option>
          <option [value]="50">50 per page</option>
          <option [value]="100">100 per page</option>
        </select>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Severity</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Reported By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let defect of getPaginatedItems(filteredDefects, 'defects')">
            <td>{{ defect.id }}</td>
            <td>{{ defect.title }}</td>
            <td>
              <span [class]="'badge ' + getPriorityColor(defect.severity)">
                {{ defect.severity }}
              </span>
            </td>
            <td>
              <span [class]="'badge ' + getStatusColor(defect.status)">
                {{ defect.status }}
              </span>
            </td>
            <td>{{ defect.assignedToUsername || 'Unassigned' }}</td>
            <td>{{ defect.reportedByUsername }}</td>
            <td>
              <button class="btn-icon" (click)="openCommentModal('defect', defect.id)" title="Comments">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                </svg>
              </button>
            </td>
          </tr>
          <tr *ngIf="getPaginatedItems(filteredDefects, 'defects').length === 0">
            <td colspan="7" class="text-center">No defects found</td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination -->
      <div class="pagination" *ngIf="totalPages.defects > 1">
        <button class="pagination-btn" (click)="goToPage(currentPage.defects - 1, 'defects')" [disabled]="currentPage.defects === 1">
          Previous
        </button>
        <span class="pagination-info">Page {{ currentPage.defects }} of {{ totalPages.defects }}</span>
        <button class="pagination-btn" (click)="goToPage(currentPage.defects + 1, 'defects')" [disabled]="currentPage.defects === totalPages.defects">
          Next
        </button>
      </div>
    </div>
  </div>

  <!-- Reports Tab -->
  <div class="tab-content" *ngIf="activeTab === 'reports'">
    <div class="reports-container" *ngIf="report; else noReport">
      <!-- Key Metrics -->
      <div class="report-section">
        <h2 class="section-title">Key Metrics</h2>
        <div class="report-grid">
          <div class="stat-card stat-card-primary">
            <h3>Total Test Cases</h3>
            <p class="stat-value">{{ report.totalTestCases }}</p>
          </div>
          <div class="stat-card stat-card-primary">
            <h3>Total Executions</h3>
            <p class="stat-value">{{ report.totalExecutions }}</p>
          </div>
          <div class="stat-card stat-card-success">
            <h3>Passed</h3>
            <p class="stat-value">{{ report.passedCount }}</p>
            <p class="stat-percentage" *ngIf="report.totalExecutions > 0">{{ getPassRate() }}%</p>
          </div>
          <div class="stat-card stat-card-danger">
            <h3>Failed</h3>
            <p class="stat-value">{{ report.failedCount }}</p>
            <p class="stat-percentage" *ngIf="report.totalExecutions > 0">{{ getFailureRate() }}%</p>
          </div>
          <div class="stat-card stat-card-warning">
            <h3>Blocked</h3>
            <p class="stat-value">{{ report.blockedCount }}</p>
          </div>
          <div class="stat-card stat-card-info">
            <h3>Retest</h3>
            <p class="stat-value">{{ report.retestCount }}</p>
          </div>
          <div class="stat-card stat-card-primary">
            <h3>Total Defects</h3>
            <p class="stat-value">{{ report.totalDefects }}</p>
          </div>
          <div class="stat-card stat-card-success">
            <h3>Defect Resolution Rate</h3>
            <p class="stat-value">{{ getDefectResolutionRate() }}%</p>
          </div>
        </div>
      </div>

      <!-- Execution Status Distribution -->
      <div class="report-section" *ngIf="report.totalExecutions > 0">
        <h2 class="section-title">Execution Status Distribution</h2>
        <div class="chart-container">
          <div class="bar-chart">
            <div class="bar-item">
              <div class="bar-label">Passed</div>
              <div class="bar-wrapper">
                <div class="bar-fill bar-success" [style.width.%]="getPassRate()"></div>
                <span class="bar-value">{{ report.passedCount }}</span>
              </div>
            </div>
            <div class="bar-item">
              <div class="bar-label">Failed</div>
              <div class="bar-wrapper">
                <div class="bar-fill bar-danger" [style.width.%]="getFailureRate()"></div>
                <span class="bar-value">{{ report.failedCount }}</span>
              </div>
            </div>
            <div class="bar-item" *ngIf="report.blockedCount > 0">
              <div class="bar-label">Blocked</div>
              <div class="bar-wrapper">
                <div class="bar-fill bar-warning" [style.width.%]="(report.blockedCount / report.totalExecutions * 100)"></div>
                <span class="bar-value">{{ report.blockedCount }}</span>
              </div>
            </div>
            <div class="bar-item" *ngIf="report.retestCount > 0">
              <div class="bar-label">Retest</div>
              <div class="bar-wrapper">
                <div class="bar-fill bar-info" [style.width.%]="(report.retestCount / report.totalExecutions * 100)"></div>
                <span class="bar-value">{{ report.retestCount }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Case Status Distribution -->
      <div class="report-section" *ngIf="report.statusDistribution">
        <h2 class="section-title">Test Case Status Distribution</h2>
        <div class="distribution-grid">
          <div class="dist-item" *ngFor="let status of getObjectKeys(report.statusDistribution)">
            <span class="dist-label">{{ status }}</span>
            <span class="dist-value">{{ report.statusDistribution[status] }}</span>
          </div>
        </div>
      </div>

      <!-- Priority Distribution -->
      <div class="report-section" *ngIf="report.priorityDistribution">
        <h2 class="section-title">Priority Distribution</h2>
        <div class="distribution-grid">
          <div class="dist-item" *ngFor="let priority of getObjectKeys(report.priorityDistribution)">
            <span class="dist-label">{{ priority }}</span>
            <span class="dist-value">{{ report.priorityDistribution[priority] }}</span>
          </div>
        </div>
      </div>

      <!-- Defect Status Distribution -->
      <div class="report-section" *ngIf="report.defectStatusDistribution">
        <h2 class="section-title">Defect Status Distribution</h2>
        <div class="distribution-grid">
          <div class="dist-item" *ngFor="let status of getObjectKeys(report.defectStatusDistribution)">
            <span class="dist-label">{{ status }}</span>
            <span class="dist-value">{{ report.defectStatusDistribution[status] }}</span>
          </div>
        </div>
      </div>

      <!-- Defect Severity Distribution -->
      <div class="report-section" *ngIf="report.defectSeverityDistribution">
        <h2 class="section-title">Defect Severity Distribution</h2>
        <div class="distribution-grid">
          <div class="dist-item" *ngFor="let severity of getObjectKeys(report.defectSeverityDistribution)">
            <span class="dist-label">{{ severity }}</span>
            <span class="dist-value">{{ report.defectSeverityDistribution[severity] }}</span>
          </div>
        </div>
      </div>
    </div>
    <ng-template #noReport>
      <div class="no-data-message">
        <p>No report data available. Please generate a report.</p>
      </div>
    </ng-template>
  </div>

  <!-- Modals -->
  <!-- Module Modal -->
  <div class="modal-overlay" *ngIf="showModuleModal" (click)="showModuleModal = false">
    <div class="modal" (click)="$event.stopPropagation()">
      <h2>Create Test Module</h2>
      <form [formGroup]="moduleForm" (ngSubmit)="createModule()">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" formControlName="name" class="form-input" [class.error]="moduleForm.get('name')?.invalid && moduleForm.get('name')?.touched">
          <div class="error-message" *ngIf="moduleForm.get('name')?.invalid && moduleForm.get('name')?.touched">
            <span *ngIf="moduleForm.get('name')?.errors?.['required']">Module name is required</span>
          </div>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea formControlName="description" class="form-input" rows="3"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="showModuleModal = false" [disabled]="loading">Cancel</button>
          <button type="submit" class="btn-primary" [disabled]="loading || moduleForm.invalid">
            <span *ngIf="loading">Creating...</span>
            <span *ngIf="!loading">Create</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Test Case Modal -->
  <div class="modal-overlay" *ngIf="showTestCaseModal" (click)="showTestCaseModal = false">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <h2>{{ selectedTestCase ? 'Edit' : 'Create' }} Test Case</h2>
      <form [formGroup]="testCaseForm" (ngSubmit)="createTestCase()">
        <div class="form-group">
          <label>Title *</label>
          <input type="text" formControlName="title" class="form-input" [class.error]="testCaseForm.get('title')?.invalid && testCaseForm.get('title')?.touched">
          <div class="error-message" *ngIf="testCaseForm.get('title')?.invalid && testCaseForm.get('title')?.touched">
            <span *ngIf="testCaseForm.get('title')?.errors?.['required']">Title is required</span>
            <span *ngIf="testCaseForm.get('title')?.errors?.['minlength']">Title must be at least 3 characters</span>
          </div>
        </div>
        <div class="form-group">
          <label>Preconditions</label>
          <textarea formControlName="preconditions" class="form-input" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Steps (one per line) *</label>
          <textarea formControlName="steps" class="form-input" rows="5" placeholder="Enter steps separated by new lines" [class.error]="testCaseForm.get('steps')?.invalid && testCaseForm.get('steps')?.touched"></textarea>
          <div class="error-message" *ngIf="testCaseForm.get('steps')?.invalid && testCaseForm.get('steps')?.touched">
            <span *ngIf="testCaseForm.get('steps')?.errors?.['required']">At least one step is required (enter steps separated by new lines)</span>
          </div>
        </div>
        <div class="form-group">
          <label>Expected Result</label>
          <textarea formControlName="expectedResult" class="form-input" rows="3"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Priority *</label>
            <select formControlName="priority" class="form-input">
              <option [value]="Priority.LOW">Low</option>
              <option [value]="Priority.MEDIUM">Medium</option>
              <option [value]="Priority.HIGH">High</option>
              <option [value]="Priority.CRITICAL">Critical</option>
            </select>
          </div>
          <div class="form-group">
            <label>Module</label>
            <select formControlName="moduleId" class="form-input">
              <option [value]="null">None</option>
              <option *ngFor="let module of modules" [value]="module.id">{{ module.name }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Assign To</label>
            <select formControlName="assignedToId" class="form-input">
              <option [value]="null">Unassigned</option>
              <option *ngFor="let user of users" [value]="user.id">{{ user.username }}</option>
            </select>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="showTestCaseModal = false" [disabled]="loading">Cancel</button>
          <button type="submit" class="btn-primary" [disabled]="loading || testCaseForm.invalid">
            <span *ngIf="loading">Creating...</span>
            <span *ngIf="!loading">{{ selectedTestCase ? 'Update' : 'Create' }}</span>
          </button>
        </div>
        <div class="form-debug" *ngIf="testCaseForm.invalid && testCaseForm.touched" style="margin-top: 1rem; padding: 0.75rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; color: #991b1b; font-size: 0.875rem;">
          Please fix the form errors above before submitting.
        </div>
      </form>
    </div>
  </div>

  <!-- Execution Modal -->
  <div class="modal-overlay" *ngIf="showExecutionModal" (click)="showExecutionModal = false">
    <div class="modal" (click)="$event.stopPropagation()">
      <h2>Execute Test Case</h2>
      <form [formGroup]="executionForm" (ngSubmit)="createExecution()">
        <div class="form-group">
          <label>Test Case *</label>
          <select formControlName="testCaseId" class="form-input">
            <option [value]="null">Select Test Case</option>
            <option *ngFor="let tc of testCases" [value]="tc.id">{{ tc.title }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status *</label>
          <select formControlName="status" class="form-input">
            <option [value]="ExecutionStatus.PASSED">Passed</option>
            <option [value]="ExecutionStatus.FAILED">Failed</option>
            <option [value]="ExecutionStatus.BLOCKED">Blocked</option>
            <option [value]="ExecutionStatus.RETEST">Retest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Comments</label>
          <textarea formControlName="comments" class="form-input" rows="4"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="showExecutionModal = false">Cancel</button>
          <button type="submit" class="btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Defect Modal -->
  <div class="modal-overlay" *ngIf="showDefectModal" (click)="showDefectModal = false">
    <div class="modal" (click)="$event.stopPropagation()">
      <h2>Log Defect</h2>
      <form [formGroup]="defectForm" (ngSubmit)="createDefect()">
        <div class="form-group">
          <label>Title *</label>
          <input type="text" formControlName="title" class="form-input">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea formControlName="description" class="form-input" rows="4"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Severity *</label>
            <select formControlName="severity" class="form-input">
              <option [value]="DefectSeverity.LOW">Low</option>
              <option [value]="DefectSeverity.MEDIUM">Medium</option>
              <option [value]="DefectSeverity.HIGH">High</option>
              <option [value]="DefectSeverity.CRITICAL">Critical</option>
            </select>
          </div>
          <div class="form-group">
            <label>Assign To</label>
            <select formControlName="assignedToId" class="form-input">
              <option [value]="null">Unassigned</option>
              <option *ngFor="let user of users" [value]="user.id">{{ user.username }}</option>
            </select>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="showDefectModal = false">Cancel</button>
          <button type="submit" class="btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Comment Modal -->
  <div class="modal-overlay" *ngIf="showCommentModal" (click)="showCommentModal = false">
    <div class="modal" (click)="$event.stopPropagation()">
      <h2>Comments</h2>
      <div class="comments-list">
        <div class="comment-item" *ngFor="let comment of comments">
          <div class="comment-header">
            <strong>{{ comment.createdByUsername }}</strong>
            <span class="text-sm text-gray-500">{{ comment.createdAt | date:'short' }}</span>
          </div>
          <div class="comment-content">{{ comment.content }}</div>
        </div>
      </div>
      <form [formGroup]="commentForm" (ngSubmit)="createComment()" class="comment-form">
        <textarea formControlName="content" class="form-input" rows="3" placeholder="Add a comment..."></textarea>
        <button type="submit" class="btn-primary">Post Comment</button>
      </form>
    </div>
  </div>
</div>

