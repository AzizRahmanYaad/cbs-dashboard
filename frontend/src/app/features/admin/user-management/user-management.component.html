<div class="user-management">
  <section class="hero-card">
    <div class="hero-card__content">
      <p class="eyebrow">Administration · Access Control</p>
      <h1>Enterprise User Management</h1>
      <p>Streamline onboarding, map granular module permissions, and oversee user lifecycle from one command center.</p>
      <div class="hero-card__actions">
        <button type="button" class="ghost-button" (click)="startCreate()">Reset Form</button>
        <span *ngIf="isEditing" class="editing-pill">Editing {{ editingUser?.username }}</span>
      </div>
    </div>
    <div class="hero-card__stats">
      <div class="stat-card">
        <p>Total Users</p>
        <h3>{{ totalUserCount }}</h3>
      </div>
      <div class="stat-card">
        <p>Active</p>
        <h3>{{ activeUsersCount }}</h3>
      </div>
      <div class="stat-card">
        <p>Inactive</p>
        <h3>{{ inactiveUsersCount }}</h3>
      </div>
      <div class="stat-card">
        <p>Roles Selected</p>
        <h3>{{ selectedRoleCount }}</h3>
      </div>
    </div>
  </section>

  <div class="layout-grid">
    <section class="panel profile-panel">
      <header class="panel-header">
        <div>
          <p class="eyebrow">{{ isEditing ? 'Update Profile' : 'Create Profile' }}</p>
          <h2>{{ isEditing ? 'Edit Existing User' : 'Register New User' }}</h2>
        </div>
        <button type="button" class="secondary-button" (click)="startCreate()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 4v12M4 10h12"/>
          </svg>
          {{ isEditing ? 'Create Instead' : 'Start Fresh' }}
        </button>
      </header>

      <form [formGroup]="userForm" (ngSubmit)="submitForm()" class="user-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="username">Username</label>
            <input 
              id="username"
              type="text" 
              formControlName="username" 
              [class.invalid]="userForm.get('username')?.invalid && userForm.get('username')?.touched"
              [readonly]="isEditing"
              placeholder="e.g. jdoe"
            />
            <small *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched">
              Username is required (minimum 3 characters)
            </small>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input 
              id="email"
              type="email" 
              formControlName="email" 
              [class.invalid]="userForm.get('email')?.invalid && userForm.get('email')?.touched"
              placeholder="name@company.com"
            />
            <small *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
              Please enter a valid email
            </small>
          </div>

          <div class="form-group">
            <label for="password">{{ isEditing ? 'Temporary Password (optional)' : 'Password' }}</label>
            <input 
              id="password"
              type="password" 
              formControlName="password" 
              [class.invalid]="userForm.get('password')?.invalid && userForm.get('password')?.touched"
              placeholder="••••••••"
            />
            <small *ngIf="!isEditing">Minimum 8 characters required</small>
            <small *ngIf="isEditing && userForm.get('password')?.invalid && userForm.get('password')?.touched">
              Password must be at least 8 characters
            </small>
          </div>

          <div class="form-group status-toggle">
            <label>Account Status</label>
            <div class="status-toggle__control">
              <span>{{ userForm.get('enabled')?.value ? 'Active' : 'Disabled' }}</span>
              <label class="switch">
                <input type="checkbox" formControlName="enabled" />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>

        <div class="role-board">
          <div class="role-board__header">
            <div>
              <p class="eyebrow">Role Matrix</p>
              <h3>Assign Roles by Module</h3>
            </div>
            <div class="role-board__summary">
              {{ selectedRoleCount }} roles selected
            </div>
          </div>

          <div class="role-accordion">
            <article 
              class="role-module"
              *ngFor="let moduleRole of moduleRoles; trackBy: trackByModuleName"
              [class.expanded]="isModuleExpanded(moduleRole.moduleName)"
            >
              <header 
                class="role-module__header"
                role="button"
                tabindex="0"
                (click)="toggleModule(moduleRole.moduleName)"
                (keydown.enter)="toggleModule(moduleRole.moduleName)"
                (keydown.space)="toggleModule(moduleRole.moduleName)"
                [attr.aria-expanded]="isModuleExpanded(moduleRole.moduleName)"
              >
                <div>
                  <p class="module-eyebrow">{{ moduleRole.moduleName | uppercase }}</p>
                  <h4>{{ moduleRole.moduleDisplayName }}</h4>
                </div>
                <div class="role-module__meta">
                  <span>{{ moduleRole.roles.length }} roles</span>
                  <span *ngIf="getSelectedCountForModule(moduleRole) > 0" class="chip">
                    {{ getSelectedCountForModule(moduleRole) }} selected
                  </span>
                  <svg 
                    class="chevron"
                    [class.open]="isModuleExpanded(moduleRole.moduleName)"
                    width="18" height="18" viewBox="0 0 24 24" stroke-width="2" fill="none" stroke="currentColor">
                    <path d="M6 9l6 6 6-6"/>
                  </svg>
                </div>
              </header>
              <div 
                class="role-module__body"
                [class.open]="isModuleExpanded(moduleRole.moduleName)"
                [attr.aria-hidden]="!isModuleExpanded(moduleRole.moduleName)"
              >
                <div class="role-chip-grid">
                  <label 
                    *ngFor="let role of moduleRole.roles; trackBy: trackByRoleName"
                    class="role-chip"
                    [class.selected]="isRoleSelected(role.name)"
                  >
                    <input
                      #roleCheckbox
                      type="checkbox"
                      [checked]="isRoleSelected(role.name)"
                      (change)="onRoleToggle(role.name, roleCheckbox.checked)"
                    />
                    <div>
                      <span class="chip-title">{{ formatRoleName(role.name) }}</span>
                      <span class="chip-desc">{{ role.description }}</span>
                    </div>
                  </label>
                </div>
              </div>
            </article>
          </div>
          <small *ngIf="rolesControl.value.length === 0" class="warning-text">
            Please select at least one role
          </small>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="isSubmitting || userForm.invalid">
            <span *ngIf="!isSubmitting">{{ isEditing ? 'Update User' : 'Create User' }}</span>
            <span *ngIf="isSubmitting">Processing...</span>
          </button>
        </div>
      </form>
    </section>

    <section class="panel directory-panel">
      <header class="panel-header">
        <div>
          <p class="eyebrow">User Directory</p>
          <h2>Access Overview</h2>
        </div>
        <span class="panel-pill">{{ totalElements }} records</span>
      </header>

      <div class="toolbar">
        <div class="search-field">
          <svg width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
            <circle cx="11" cy="11" r="7" />
            <path d="M21 21l-4.35-4.35" />
          </svg>
          <input 
            type="text" 
            placeholder="Search by username or email..."
            (input)="onSearchChange($event)"
          />
        </div>
        <div class="filter-pills">
          <button 
            *ngFor="let filter of ['all', 'active', 'inactive']"
            type="button"
            [class.active]="statusFilter === filter"
            (click)="onStatusFilterChange(filter)"
          >
            {{ filter === 'all' ? 'All' : filter === 'active' ? 'Active' : 'Inactive' }}
          </button>
        </div>
      </div>

      <div class="directory-table">
        <div *ngIf="isLoading" class="loading-state">
          <div class="spinner"></div>
          <p>Loading users...</p>
        </div>

        <table *ngIf="!isLoading">
          <thead>
            <tr>
              <th>User</th>
              <th>Assigned Roles</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users; trackBy: trackByUserId">
              <td>
                <div class="user-row__identity">
                  <strong>{{ user.username }}</strong>
                  <small>{{ user.email }}</small>
                </div>
              </td>
              <td>
                <div class="role-badge-group">
                  <span 
                    *ngFor="let role of user.roles" 
                    class="role-badge"
                    [title]="role"
                  >
                    {{ formatRoleName(role) }}
                  </span>
                  <span *ngIf="!user.roles || user.roles.length === 0" class="badge-muted">No roles</span>
                </div>
              </td>
              <td>
                <span class="status-chip" [class.active]="user.enabled">
                  {{ user.enabled ? 'Active' : 'Disabled' }}
                </span>
              </td>
              <td class="table-actions">
                <button type="button" class="link-button" (click)="editUser(user)">Edit</button>
              </td>
            </tr>
            <tr *ngIf="!isLoading && users.length === 0">
              <td colspan="4" class="empty-state">
                <p>No users found</p>
                <small *ngIf="searchTerm">Try adjusting your search or filters</small>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination-bar" *ngIf="!isLoading && totalPages > 1">
        <div class="range">
          Showing {{ currentPage * pageSize + 1 }} - {{ Math.min((currentPage + 1) * pageSize, totalElements) }} of {{ totalElements }}
        </div>
        <div class="pager">
          <button 
            type="button"
            [disabled]="currentPage === 0"
            (click)="onPageChange(currentPage - 1)"
          >
            Previous
          </button>
          <div class="pages">
            <button
              *ngFor="let page of getPageNumbers()"
              type="button"
              [class.active]="page === currentPage"
              (click)="onPageChange(page)"
            >
              {{ page + 1 }}
            </button>
          </div>
          <button 
            type="button"
            [disabled]="currentPage >= totalPages - 1"
            (click)="onPageChange(currentPage + 1)"
          >
            Next
          </button>
        </div>
        <div class="page-size">
          <label>Per page</label>
          <select (change)="onPageSizeChange($event)" [value]="pageSize">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>
      </div>
    </section>
  </div>
</div>
